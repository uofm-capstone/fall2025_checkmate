<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Page with Sidebar</title>
  <style>
    .sidebar {
      width: 250px;
      height: 100%;
      padding: 1rem;
      position: fixed;
      left: 0;
      top: 56px; /* Height of the top navbar */
      overflow-y: auto;
      background-color: #f8f9fa;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1020;
    }
    .sidebar h2, .sidebar h3, .sidebar h5 {
      color: #343a40;
    }
    .sidebar a {
      color: #343a40;
    }
    .sidebar .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: #ffffff;
    }

    @media (max-width: 992px) {
      .sidebar {
        display: none;
      }
      .main-content,
      .upload-buttons-container {
        margin-left: 0;
      }
    }

    body {
      overflow-x: hidden; /* Prevent page-wide horizontal scroll */
    }

    .main-content {
      flex: 1;
      border: 2px solid #ffffff;
      border-radius: 10px;
      padding: 20px;
      min-width: 0;
      overflow-y: visible; /* Allow normal page scroll */
      overflow-x: hidden;  /* Prevent horizontal scroll on the page itself */
    }

    .table-responsive {
      display: block;
      width: 100%;
      overflow-x: auto;           /* Horizontal scroll only for wide tables */
      overflow-y: hidden;         /* Prevent vertical scroll inside the table */
      -webkit-overflow-scrolling: touch;
      margin-bottom: 20px;
      padding-right: 40px;
    }

    .top-warning {
      position: fixed;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      z-index: 1050;
    }

    .navbar {
      z-index: 1030;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      right: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      width: auto;
      margin-right: 20px;
    }

    /* Upload buttons container */
    .upload-buttons-container {
      position: relative;
      z-index: 1;
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-left: 250px; /* Match sidebar width */
    }

    .upload-card {
      width: 300px;
      margin-bottom: 20px;
    }

    .tooltip-inner {
      max-width: 250px;     /* prevent super-wide tooltips */
      font-size: 0.85rem;   /* slightly smaller for readability */
      line-height: 1.4;
      text-align: left;     /* aligns multi-line text nicely */
      padding: 8px 10px;
    }

    .table-responsive {
      overflow-x: auto;
      position: relative;
    }



  </style>
</head>
<body>

  <div class="container mt-3">
    <div class="d-flex">
      <div class="main-content">
        <!-- Warning for No Student CSV Uploaded -->
        <% unless @semester.student_csv.attached? %>
          <div class="d-flex justify-content-center mt-4 mb-4">
            <div class="card w-100 border-danger">
              <div class="card-body bg-danger text-white">
                <p class="card-text text-center">
                  <strong>Attention:</strong> No Student CSV has been uploaded for this semester. Please upload the student csv to display the data
                </p>
              </div>
            </div>
          </div>
        <% end %>

        <div class="row">
          <div class="mt-4 text-center">
            <% if team_exist(@teams) %>
              <h2 class="">Team Status</h2>
              <div class="mt-3 mb-3">
                <h5 class="">Legend:</h5>
                <ul class="list-inline">
                  <li class="list-inline-item">
                    <%= image_tag "check-circle-fill.svg", style: "height:16px" %> Good
                  </li>
                  <li class="list-inline-item">
                    <%= image_tag "exclamation-circle-fill-yellow.svg", style: "height:16px" %> Acceptable
                  </li>
                  <li class="list-inline-item">
                    <%= image_tag "exclamation-triangle-fill-red.svg", style: "height:16px" %> Poor
                  </li>
                  <li class="list-inline-item">
                    <%= image_tag "question-circle-fill.svg", style: "height:16px" %> No Data
                  </li>
                </ul>
              </div>

              <!-- Warning for No Client CSV Uploaded -->
              <!--
              <% unless @semester.client_csv.attached? %>
                <div class="d-flex justify-content-center mt-4 mb-4">
                  <div class="card w-100 border-danger">
                    <div class="card-body bg-danger text-white">
                      <p class="card-text text-center">
                        <strong>Attention:</strong> No Client CSV has been uploaded for this semester. Please upload the client csv to display the correct data.
                      </p>
                    </div>
                  </div>
                </div>
              <% end %>
              -->
              
              <div class="table-responsive">
                <table class="table table-bordered align-middle text-center">
                  <thead>
                    <tr>
                      <th rowspan="3">Team Name</th>
                      <th rowspan="3">Member</th>
                      <% @sprint_list.each do |sprint| %>
                        <th colspan="15"><%= sprint %></th>
                      <% end %>
                    </tr>

                    <tr>
                      <% @sprint_list.each do |_sprint| %>
                        <th colspan="4">Planning</th>
                        <th colspan="4">PC</th>
                        <th colspan="7">Demo</th>
                      <% end %>
                    </tr>
                      <tr>
                        <% rubric_items = ["FS&D", "FA", "TE", "KU", "TS", "PP", "CC", "SR", "TSP", "PP", "PF", "CBP", "CC", "SR", "D"] %>

                        <% @sprint_list.each do |_sprint| %>
                          <% rubric_items.each do |item| %>
                            <% tooltip = case item
                              when "FS&D"
                                "<strong>Feature Selection and Decomposition</strong><br><b>Metric:</b> Number of cards per column."
                              when "FA"
                                "<strong>Feature Assignments</strong><br><b>Metric:</b> Number of cards assigned to each team member."
                              when "TE"
                                "<strong>Feature Time Estimates</strong><br><b>Metric:</b> Sum of estimated hours per team member."
                              when "KU"
                                "<strong>Kanban Updates</strong><br><b>Metric:</b> N/A."
                              when "TS"
                                "<strong>Time Spent</strong><br><b>Metric:</b> N/A."
                              when "PP"
                                "<strong>Product Progress</strong><br><b>Metric:</b> Count of cards moved through workflow (To-Do → In-Progress → Done) per team member."
                              when "CC"
                                "<strong>Client Communication</strong><br><b>Metric:</b> N/A."
                              when "CBP"
                                "<strong>Coding Best Practices</strong><br><b>Metric:</b> Count of commits and lines of code changed per team member."
                              when "SR"
                                "<strong>Status and Reflection</strong><br><b>Metric:</b> N/A."
                              when "TSP"
                                "<strong>Time Spent Since Progress Check</strong><br><b>Metric:</b> Sum of work hours or task updates since the last progress check."
                              when "PF"
                                "<strong>Product Feedback</strong><br><b>Metric:</b> N/A."
                              when "D"
                                "<strong>Demo</strong><br><b>Metric:</b> N/A."
                              else
                                "<strong>Metric</strong><br><b>Metric:</b> Description unavailable."
                              end %>

                            <th data-bs-toggle="tooltip"
                                data-bs-html="true"
                                data-bs-placement="top"
                                title="<%= tooltip.html_safe %>"
                                style="font-size: 0.75rem;">
                              <%= item %>
                            </th>
                          <% end %>
                        <% end %>
                      </tr>
                  </thead>

                  <tbody>
                    <% @teams.each do |team| %>
                      <% team.students.each_with_index do |student, i| %>
                        <tr>
                          <%# Only show team name in the first student row %>
                          <% if i == 0 %>
                            <td rowspan="<%= team.students.size %>">
                              <%= link_to team.name, semester_team_path(@semester, team: team, sprint: @sprint_list.first), class: "text-decoration-none fw-semibold" %>
                            </td>
                          <% end %>

                          <td style="white-space: nowrap;">
                            <%= "#{student.name.split.first} #{student.name.split.last&.first}." %>
                          </td>

                          <% @sprint_list.each do |sprint| %>
                            <% rubric_items.each do |item| %>
                              <td class="text-center">
                              <%=
                                case item
                                when "FS&D"
                                  # Feature Selection and Decomposition — Metric: Number of cards per column
                                  image_tag "question-circle-fill.svg", style: "height:16px"

                                when "FA"
                                  # Feature Assignments — Metric: Number of cards assigned to each team member
                                  image_tag "question-circle-fill.svg", style: "height:16px"

                                when "TE"
                                  # Feature Time Estimates — Metric: Sum of estimated hours per team member
                                  image_tag "question-circle-fill.svg", style: "height:16px"

                                when "PP"
                                  # Product Progress — Metric: Cards moved through workflow (To-Do → In-Progress → Done)
                                  image_tag "question-circle-fill.svg", style: "height:16px"

                                when "CBP"
                                  # Coding Best Practices — Metric: Count of commits and lines of code changed per team member
                                  image_tag "question-circle-fill.svg", style: "height:16px"

                                when "TSP"
                                  # Time Spent Since Progress Check — Metric: Sum of work hours or task updates since last progress check
                                  image_tag "question-circle-fill.svg", style: "height:16px"

                                when "KU", "TS", "CC", "SR", "PF", "D"
                                  # N/A metrics — Metric: Not applicable (no direct data collected)
                                  image_tag "question-circle-fill.svg", style: "height:16px"

                                else
                                  # Unknown rubric type — Metric: Description unavailable
                                  image_tag "question-circle-fill.svg", style: "height:16px"
                                end
                              %>
                            </td>
                            <% end %>
                          <% end %>

                        </tr>
                      <% end %>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sprint-specific Upload CSV Forms -->
<!--  <div class="container">
    <div class="upload-buttons-container">
      <% @sprint_list.each_with_index do |sprint, i| %>
        <div class="card upload-card">
          <div class="card-body">
            <h5 class="card-title">Sprint <%= i + 1 %> CSV Upload</h5>
            <%= form_with(url: upload_sprint_csv_semester_path(@semester), method: :post, local: true, html: { multipart: true }) do |f| %>
              <div class="mb-3">
                <%= f.label :student_csv, "Student CSV" %>
                <%= f.file_field :student_csv, accept: ".csv", class: "form-control" %>
              </div>
              <div class="mb-3">
                <%= f.label :client_csv, "Client CSV" %>
                <%= f.file_field :client_csv, accept: ".csv", class: "form-control" %>
              </div>
              <%= hidden_field_tag :sprint_number, sprint %>
              <div class="d-grid">
                <%= f.submit "Upload for #{sprint}", class: "btn btn-primary" %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div> -->

  <!-- Upload CSV Modal -->
  <%= javascript_include_tag 'survey_page/survey_scroll_navigation' %>
  <%= javascript_include_tag 'survey_page/survey_page_expanding_cols' %>
  <%= javascript_include_tag 'octokit', type: "module" %>
</body>
</html>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
  });
</script>