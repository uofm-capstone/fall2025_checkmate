<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Status</title>
  <style>
    .status-container {
      max-width: 95%;
      margin: 0 auto;
      padding: 20px;
    }
    .legend-container {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .status-table {
      width: 100%;
      overflow-x: auto;
      margin-bottom: 30px;
    }
    .status-table table {
      min-width: 1200px;
    }
    .sprint-upload-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .warning-banner {
      position: sticky;
      top: 0;
      z-index: 1000;
      margin-bottom: 20px;
    }
    .table th {
      background-color: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .table td {
      vertical-align: middle;
    }
    .team-name {
      font-weight: 500;
      color: #0d6efd;
    }
    .team-name:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="status-container">
    <!-- Warning for No Student CSV Uploaded -->
    <% unless @semester.student_csv.attached? %>
      <div class="warning-banner">
        <div class="alert alert-danger" role="alert">
          <strong>Attention:</strong> No Student CSV has been uploaded for this semester. Please upload the student csv to display the data.
        </div>
      </div>
    <% end %>

    <!-- Warning for No Client CSV Uploaded -->
    <% unless @semester.client_csv.attached? %>
      <div class="warning-banner">
        <div class="alert alert-danger" role="alert">
          <strong>Attention:</strong> No Client CSV has been uploaded for this semester. Please upload the client csv to display the correct data.
        </div>
      </div>
    <% end %>

    <% if team_exist(@teams) %>
      <div class="text-center mb-4">
        <h2>Team Status</h2>
      </div>

      <div class="legend-container">
        <h5 class="text-center mb-3">Legend</h5>
        <div class="d-flex justify-content-center flex-wrap gap-4">
          <div class="d-flex align-items-center">
            <%= image_tag "check-circle-fill.svg", style: "height:16px; margin-right: 8px" %>
            <span>All Good</span>
          </div>
          <div class="d-flex align-items-center">
            <%= image_tag "question-circle-fill.svg", style: "height:16px; margin-right: 8px" %>
            <span>No Data Uploaded</span>
          </div>
          <div class="d-flex align-items-center">
            <%= image_tag "exclamation-circle-fill-yellow.svg", style: "height:16px; margin-right: 8px" %>
            <span>No Client Survey</span>
          </div>
          <div class="d-flex align-items-center">
            <%= image_tag "exclamation-triangle-fill-red.svg", style: "height:16px; margin-right: 8px" %>
            <span>Poor Performance</span>
          </div>
        </div>
        <p class="text-center mt-2 text-muted">Note: Hover over warning symbols to see more details</p>
      </div>

      <div class="status-table">
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th rowspan="3" class="text-center">Team</th>
              <% @sprint_list.each do |sprint| %>
                <th colspan="15" class="text-center"><%= sprint %></th>
              <% end %>
            </tr>
            <tr>
              <% @sprint_list.each do |_sprint| %>
                <th colspan="4" class="text-center">Planning</th>
                <th colspan="4" class="text-center">PC</th>
                <th colspan="6" class="text-center">Demo</th>
                <th rowspan="2" class="text-center">CF</th>
              <% end %>
            </tr>
            <tr>
              <% @sprint_list.each do |_sprint| %>
                <% ["FS&D", "FA", "TE", "KU", "TS", "PP", "CC", "SR", "TSP", "PP", "PF", "CC", "SR", "D"].each do |item| %>
                  <th class="text-center" style="font-size: 0.75rem;"><%= item %></th>
                <% end %>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @teams.each do |team| %>
              <tr>
                <td>
                  <%= link_to team, semester_team_path(@semester, team: team, sprint: @sprint_list.first), class: "team-name" %>
                </td>
                <% @sprint_list.each do |sprint| %>
                  <% indicators = @flags[sprint][team] || [] %>
                  <% ["FS&D", "FA", "TE", "KU", "TS", "PP", "CC", "SR", "TSP", "PP", "PF", "CC", "SR", "D", "CF"].each do |rubric_item| %>
                    <td class="text-center">
                      <% if rubric_item == "CF" %>
                        <% if indicators.include?("no client score") %>
                          <%= image_tag "question-circle-fill.svg", style: "height:16px", title: "No client feedback available" %>
                        <% elsif indicators.include?("incomplete client feedback") %>
                          <%= image_tag "exclamation-circle-fill-yellow.svg", style: "height:16px", title: "Incomplete client feedback" %>
                        <% elsif indicators.include?("low client score") %>
                          <%= image_tag "exclamation-triangle-fill-red.svg", style: "height:16px", title: "Low client feedback score" %>
                        <% else %>
                          <%= image_tag "check-circle-fill.svg", style: "height:16px", title: "Client feedback received" %>
                        <% end %>
                      <% else %>
                        <% if indicators.include?("no data") %>
                          <%= image_tag "question-circle-fill.svg", style: "height:16px" %>
                        <% elsif indicators.include?("low score") %>
                          <%= image_tag "exclamation-triangle-fill-red.svg", style: "height:16px" %>
                        <% else %>
                          <%= image_tag "check-circle-fill.svg", style: "height:16px" %>
                        <% end %>
                      <% end %>
                    </td>
                  <% end %>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="sprint-upload-section">
        <h4 class="text-center mb-4">Sprint CSV Uploads</h4>
        <div class="row">
          <% @sprint_list.each_with_index do |sprint, i| %>
            <div class="col-md-6 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">Sprint <%= i + 1 %></h5>
                  <%= form_with(url: upload_sprint_csv_semester_path(@semester), method: :post, local: true, html: { multipart: true }) do |f| %>
                    <div class="mb-3">
                      <%= f.label :student_csv, "Student CSV", class: "form-label" %>
                      <%= f.file_field :student_csv, accept: ".csv", class: "form-control" %>
                    </div>
                    <div class="mb-3">
                      <%= f.label :client_csv, "Client CSV", class: "form-label" %>
                      <%= f.file_field :client_csv, accept: ".csv", class: "form-control" %>
                    </div>
                    <%= hidden_field_tag :sprint_number, sprint %>
                    <div class="d-grid">
                      <%= f.submit "Upload for #{sprint}", class: "btn btn-primary" %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <%= javascript_include_tag 'survey_page/survey_scroll_navigation' %>
  <%= javascript_include_tag 'survey_page/survey_page_expanding_cols' %>
  <%= javascript_include_tag 'octokit', type: "module" %>
</body>
</html>
