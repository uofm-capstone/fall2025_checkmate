<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Page with Sidebar</title>

  <style>
    .sidebar {
      width: 250px;
      height: 100%;
      padding: 1rem;
      position: fixed;
      left: 0;
      top: 56px; /* Height of the top navbar */
      overflow-y: auto;
      background-color: #f8f9fa;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1020;
    }

    .sidebar h2, .sidebar h3, .sidebar h5 {
      color: #343a40;
    }

    .sidebar a {
      color: #343a40;
    }

    .sidebar .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: #ffffff;
    }

    @media (max-width: 992px) {
      .sidebar {
        display: none;
      }

      .main-content,
      .upload-buttons-container {
        margin-left: 0;
      }
    }

    body {
      overflow-x: hidden;
    }

    .main-content {
      flex: 1;
      border: 2px solid #ffffff;
      border-radius: 10px;
      padding: 20px;
      min-width: 0;
      overflow-y: visible;
      overflow-x: hidden;
    }

    .table-responsive {
      display: block;
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 20px;
      padding-right: 40px;
      position: relative;
    }

    .top-warning {
      position: fixed;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      z-index: 1050;
    }

    .navbar {
      z-index: 1030;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      right: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      width: auto;
      margin-right: 20px;
    }

    .upload-buttons-container {
      position: relative;
      z-index: 1;
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-left: 250px;
    }

    .upload-card {
      width: 300px;
      margin-bottom: 20px;
    }

    .tooltip-inner {
      max-width: 250px;
      font-size: 0.85rem;
      line-height: 1.4;
      text-align: left;
      padding: 8px 10px;
    }

    .table {
      border-collapse: separate;
      border-spacing: 0;
      white-space: nowrap;
    }

    .table thead th {
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 5;
    }

    .table th.sticky-col-1,
    .table td.sticky-col-1 {
      position: sticky;
      left: 0;
      background: #f8f9fa;
      z-index: 6; /* higher so it stays above scrolling cells */
    }

    .table th.sticky-col-2,
    .table td.sticky-col-2 {
      position: sticky;
      left: 98px; /* match width of first column */
      background: #f8f9fa;
      z-index: 6;
    }

    /* Sprint buttons */
    .sprint-toggle.active {
      background-color: #0d6efd;
      color: #ffffff;
    }
  </style>
</head>

<body>
  <div class="container mt-3">
    <div class="d-flex">
      <div class="main-content">

        <!-- Warning for No Student CSV Uploaded -->
        <% unless @semester.student_csv.attached? %>
          <div class="d-flex justify-content-center mt-4 mb-4">
            <div class="card w-100 border-danger">
              <div class="card-body bg-danger text-white">
                <p class="card-text text-center">
                  <strong>Attention:</strong> No Student CSV has been uploaded for this semester. Please upload the student CSV to display the data.
                </p>
              </div>
            </div>
          </div>
        <% end %>

        <div class="row">
          <div class="mt-4 text-center">
            <% if team_exist(@teams) %>
              <h2>Team Status</h2>

              <div class="mt-3 mb-3">
                <h5>Legend:</h5>
                <ul class="list-inline">
                  <li class="list-inline-item">
                    <%= image_tag "check-circle-fill.svg", style: "height:16px" %> Good
                  </li>
                  <li class="list-inline-item">
                    <%= image_tag "exclamation-circle-fill-yellow.svg", style: "height:16px" %> Acceptable
                  </li>
                  <li class="list-inline-item">
                    <%= image_tag "exclamation-triangle-fill-red.svg", style: "height:16px" %> Poor
                  </li>
                  <li class="list-inline-item">
                    <%= image_tag "question-circle-fill.svg", style: "height:16px" %> No Data
                  </li>
                </ul>
              </div>

              <!-- ðŸ”¹ Sprint Filter Buttons (includes "All") -->
              <div class="text-center mb-3">
                <button
                  class="btn btn-outline-primary m-1 sprint-toggle active"
                  data-sprint="all">
                  All
                </button>

                <% @sprint_list.each do |sprint| %>
                  <button
                    class="btn btn-outline-primary m-1 sprint-toggle"
                    data-sprint="<%= sprint.parameterize %>">
                    <%= sprint %>
                  </button>
                <% end %>
              </div>

              <!-- TABLE -->
              <div class="table-responsive">
                <table class="table table-bordered align-middle text-center">
                  <thead>
                    <tr>
                      <th class="sticky-col-1" rowspan="3">Team Name</th>
                      <th class="sticky-col-2" rowspan="3">Member</th>
                      <% @sprint_list.each do |sprint| %>
                        <th colspan="15" class="sprint-group <%= sprint.parameterize %>"><%= sprint %></th>
                      <% end %>
                    </tr>

                    <tr>
                      <% @sprint_list.each do |sprint| %>
                        <th colspan="4" class="sprint-group <%= sprint.parameterize %>">Planning</th>
                        <th colspan="4" class="sprint-group <%= sprint.parameterize %>">PC</th>
                        <th colspan="7" class="sprint-group <%= sprint.parameterize %>">Demo</th>
                      <% end %>
                    </tr>

                    <tr>
                      <% rubric_items = ["FS&D", "FA", "TE", "KU", "TS", "PP", "CC", "SR", "TSP", "PP", "PF", "CBP", "CC", "SR", "D"] %>
                      <% @sprint_list.each do |sprint| %>
                        <% rubric_items.each do |item| %>
                          <% tooltip = case item
                            when "FS&D" then "<strong>Feature Selection and Decomposition</strong><br><b>Metric:</b> Number of cards per column."
                            when "FA"   then "<strong>Feature Assignments</strong><br><b>Metric:</b> Number of cards assigned to each team member."
                            when "TE"   then "<strong>Feature Time Estimates</strong><br><b>Metric:</b> Sum of estimated hours per team member."
                            when "KU"   then "<strong>Kanban Updates</strong><br><b>Metric:</b> N/A."
                            when "TS"   then "<strong>Time Spent</strong><br><b>Metric:</b> N/A."
                            when "PP"   then "<strong>Product Progress</strong><br><b>Metric:</b> Cards moved through workflow (To-Do â†’ In-Progress â†’ Done)."
                            when "CC"   then "<strong>Client Communication</strong><br><b>Metric:</b> N/A."
                            when "CBP"  then "<strong>Coding Best Practices</strong><br><b>Metric:</b> Count of commits and line changes."
                            when "SR"   then "<strong>Status and Reflection</strong><br><b>Metric:</b> N/A."
                            when "TSP"  then "<strong>Time Spent Since Progress Check</strong><br><b>Metric:</b> Work hours or updates since last check."
                            when "PF"   then "<strong>Product Feedback</strong><br><b>Metric:</b> N/A."
                            when "D"    then "<strong>Demo</strong><br><b>Metric:</b> N/A."
                            else "<strong>Metric</strong><br><b>Metric:</b> Description unavailable."
                          end %>

                          <th
                            class="sprint-group <%= sprint.parameterize %>"
                            data-bs-toggle="tooltip"
                            data-bs-html="true"
                            data-bs-placement="top"
                            title="<%= tooltip.html_safe %>"
                            style="font-size: 0.75rem;">
                            <%= item %>
                          </th>
                        <% end %>
                      <% end %>
                    </tr>
                  </thead>

                  <tbody>
                    <% @teams.each do |team| %>
                      <% team.students.each_with_index do |student, i| %>
                        <tr>
                          <% if i == 0 %>
                            <td class="sticky-col-1" rowspan="<%= team.students.size %>">
                              <%= link_to team.name, teams_path(@semester), class: "text-decoration-none fw-semibold" %>
                            </td>
                          <% end %>

                          <td class="sticky-col-2" style="white-space: nowrap;">
                            <%= "#{student.name.split.first} #{student.name.split.last&.first}." %>
                          </td>

                          <% @sprint_list.each do |sprint| %>
                            <% rubric_items.each do |item| %>
                              <td class="text-center sprint-group <%= sprint.parameterize %>">
                                <% case item %>
                                  <% when "FS&D" %>
                                    <!-- Feature Selection and Decomposition â€” Metric: Number of cards per column -->
                                    <% if !@team_project_data.nil? %>
                                      <% column_count = @service.get_card_count_per_column(@team_project_data[team.name]) %>
                                      <%= "#{column_count['Backlog']}, #{column_count['Todo']}, #{column_count['In Progress']}, #{column_count['Done']}" %>
                                    <% end %>
                                  <% when "FA" %>
                                    <!-- Feature Assignments â€” Metric: Number of cards assigned to each team member -->
                                    <% if !@team_project_data.nil? %>
                                      <% assigned_count = @service.get_card_count_per_assignee(@team_project_data[team.name], student.github_username)[student.github_username] %>
                                      <%= assigned_count %>
                                    <% end %> 
                                  <% when "TE" %>
                                    <!-- Feature Time Estimates â€” Metric: Sum of estimated hours per team member -->
                                    <% if !@team_project_data.nil? %>
                                      <% estimated_hours = @service.get_total_hours_per_assignee(@team_project_data[team.name], student.github_username)[student.github_username] %>
                                      <%= estimated_hours %>
                                    <% end %>
                                  <% when "PP" %>
                                    <!-- Product Progress â€” Metric: Cards moved through workflow (To-Do â†’ In-Progress â†’ Done) per team member -->
                                    <%= image_tag "check-circle-fill.svg", style: "height:16px" %>

                                  <% when "CBP" %>
                                    <!-- Coding Best Practices â€” Metric: Count of commits and lines of code changed per team member -->
                                    <%= image_tag "check-circle-fill.svg", style: "height:16px" %>

                                  <% when "TSP" %>
                                    <!-- Time Spent Since Progress Check â€” Metric: Sum of work hours or task updates since last progress check -->
                                    <%= image_tag "check-circle-fill.svg", style: "height:16px" %>

                                  <% when "KU", "TS", "CC", "SR", "PF", "D" %>
                                    <!-- N/A metrics â€” Metric: Not applicable (no direct data collected) -->
                                    <%= image_tag "question-circle-fill.svg", style: "height:16px" %>

                                  <% else %>
                                    <!-- Unknown rubric type â€” Metric: Description unavailable -->
                                    <%= image_tag "question-circle-fill.svg", style: "height:16px" %>
                                <% end %>
                              </td>
                            <% end %>
                          <% end %>
                        </tr>
                      <% end %>
                    <% end %>
                  </tbody>
                </table>
              </div>

              <!-- Deadline Cards -->
              <div class="container mt-4">
                <h3 class="text-center mb-4">Set Sprint Deadlines</h3>

                <%= form_with url: save_sprints_semester_path(@semester), method: :post, local: true do %>
                  <div class="d-flex flex-nowrap justify-content-between gap-3 px-2">
                    <% (1..4).each do |i| %>
                      <% sprint = @semester.sprints.find_by(name: "Sprint #{i}") || Sprint.new(name: "Sprint #{i}") %>

                      <div class="card small-card flex-fill mx-1" style="min-width: 0;">
                        <div class="card-body p-2">
                          <h6 class="card-title mb-2 text-center">Sprint <%= i %></h6>

                          <div class="mb-1">
                            <%= label_tag "sprint_#{i}[planning_deadline]", "Planning Deadline", class: "form-label mb-0" %>
                            <%= date_field_tag "sprint_#{i}[planning_deadline]", sprint.planning_deadline, class: "form-control form-control-sm" %>
                          </div>

                          <div class="mb-1">
                            <%= label_tag "sprint_#{i}[progress_deadline]", "Progress Check", class: "form-label mb-0" %>
                            <%= date_field_tag "sprint_#{i}[progress_deadline]", sprint.progress_deadline, class: "form-control form-control-sm" %>
                          </div>

                          <div class="mb-1">
                            <%= label_tag "sprint_#{i}[demo_deadline]", "Demo Deadline", class: "form-label mb-0" %>
                            <%= date_field_tag "sprint_#{i}[demo_deadline]", sprint.demo_deadline, class: "form-control form-control-sm" %>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>

                  <div class="text-center mt-3">
                    <%= submit_tag "Save All Deadlines", class: "btn btn-primary px-4" %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%= javascript_include_tag 'survey_page/survey_scroll_navigation' %>
  <%= javascript_include_tag 'survey_page/survey_page_expanding_cols' %>
  <%= javascript_include_tag 'octokit', type: "module" %>

  <script>
    // Initialise tooltips + sprint filter (for both normal and Turbo loads)
    function initTooltipsAndSprintFilter() {
      // Tooltips
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      // Sprint filter
      const buttons = document.querySelectorAll(".sprint-toggle");
      const groups  = document.querySelectorAll(".sprint-group");

      if (!buttons.length || !groups.length) return;

      // Default: All visible
      groups.forEach(g => g.style.display = "");

      buttons.forEach(btn => {
        // avoid double-binding
        if (btn.dataset.sprintBound === "1") return;
        btn.dataset.sprintBound = "1";

        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          const key = btn.dataset.sprint;  // "all" or e.g. "sprint-1"

          if (key === "all") {
            groups.forEach(g => g.style.display = "");
          } else {
            groups.forEach(g => {
              g.style.display = g.classList.contains(key) ? "" : "none";
            });
          }
        });
      });
    } 

    document.addEventListener("DOMContentLoaded", initTooltipsAndSprintFilter);
    document.addEventListener("turbo:load", initTooltipsAndSprintFilter);
  </script>
</body>
</html>
