<style>
  .icon-button {
    color: #6c757d;
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: color 0.2s ease;
  }

  .icon-button:hover {
    color: #dc3545;
  }

  .icon-button i {
    pointer-events: none;
  }

  .missing {
    color: red;
    border-color: red;
    pointer-events: none;
    opacity: 0.5;
  }

  .available {
    color: green;
    border-color: green;
  }

  .link-button {
    width: 110px;
  }
</style>

<div class='d-flex justify-content-center pt-3' style='width: 100%;'>
  <div class=''>
    <h1 style='color: #0D3182;'>Teams</h1>

    <%= button_tag "New Team", 
      type: "button", 
      class: "btn btn-primary mb-2", 
      data: { bs_toggle: "modal", bs_target: "#newTeamModal" } 
    %>

    <div class="modal fade" id="newTeamModal" tabindex="-1" aria-labelledby="newTeamModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="newTeamModalLabel">Create New Team</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <%= render "form", team: @team, current_semester: @current_semester %>
          </div>
        </div>
      </div>
    </div>

    <% if @team.errors.any? %>
      <script>
        document.addEventListener("DOMContentLoaded", function() {
          var myModal = new bootstrap.Modal(document.getElementById('newTeamModal'));
          myModal.show();
        });
      </script>
    <% end %>

    <div>
      <table class='table table-hover'>
        <thead class='text-center' style='background-color: #0D3182; color: white'>
          <tr>
            <th>Team Name</th>
            <th>Members</th>
            <th>Github Token</th>
            <th>Links</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @teams.each do |team| %>
            <tr>
              <td class='align-middle text-center'><%= team.name %></td>
              <td class='align-middle'><%= team.students.map(&:email).join('<br>').html_safe %></td>
              <td class='align-middle' style='max-width: 250px; overflow-x: auto;'>
                <code><%= team.github_token %></code>
              </td>
              <td class='align-middle'>
                <div class='d-flex justify-content-center gap-2 mb-1'>
                  <%= link_to 'Repository', team.repo_url,
                    class: class_names(
                      "btn btn-outline-secondary btn-sm link-button",
                      "missing" => team.repo_url.blank?,
                      "available" => !team.repo_url.blank?
                    ), 
                    target: '_blank', 
                    rel: 'noopener' %>
                  <%= link_to 'Project Board', team.project_board_url,
                    class: class_names(
                      "btn btn-outline-secondary btn-sm link-button",
                      "missing" => team.project_board_url.blank?,
                      "available" => !team.project_board_url.blank?
                    ), 
                    target: '_blank', 
                    rel: 'noopener' %>
                </div>
                <div class='d-flex justify-content-center gap-2'>
                  <%= link_to 'Timesheet', team.timesheet_url,
                    class: class_names(
                      "btn btn-outline-secondary btn-sm link-button",
                      "missing" => team.timesheet_url.blank?,
                      "available" => !team.timesheet_url.blank?
                    ), 
                    target: '_blank', 
                    rel: 'noopener' %>
                  <%= link_to 'Client Notes', team.client_notes_url,
                    class: class_names(
                      "btn btn-outline-secondary btn-sm link-button",
                      "missing" => team.client_notes_url.blank?,
                      "available" => !team.client_notes_url.blank?
                    ), 
                    target: '_blank', 
                    rel: 'noopener' %>
                </div>
              </td>
              <td class='align-middle text-center'>
                <% if can? :modify, team %>
                  <div class="d-flex flex-column align-items-center">
                    <button type="button" class="icon-button"
                            data-bs-toggle="modal"
                            data-bs-target="#editTeamModal-<%= team.id %>">
                      <i class="bi bi-pen-fill"></i>
                    </button>

                    <button type="button" class="icon-button"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteTeamModal-<%= team.id %>">
                      <i class="bi bi-trash-fill"></i>
                    </button>
                  </div>
                <% end %>
              </td>
            </tr>

            <% if team.errors.any? %>
              <script>
                document.addEventListener("DOMContentLoaded", function() {
                  var myModal = new bootstrap.Modal(document.getElementById('editTeamModal-<%= team.id %>'));
                  myModal.show();
                });
              </script>
            <% end %>

          <% end %>
        </tbody>
      </table>

      <% @teams.each do |team| %>
        <div class="modal fade" id="editTeamModal-<%= team.id %>" tabindex="-1" aria-labelledby="editTeamModalLabel-<%= team.id %>" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editTeamModalLabel-<%= team.id %>">Edit <%= team.name %></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <%= render "form", team: team, current_semester: @current_semester %>
              </div>
            </div>
          </div>
        </div>
        <div class="modal fade" id="deleteTeamModal-<%= team.id %>" tabindex="-1" aria-labelledby="deleteTeamModalLabel-<%= team.id %>" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title text-danger" id="deleteTeamModalLabel-<%= team.id %>">
                  Are you sure you want to delete this team?
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>This action cannot be undone.</p>
              </div>
              <div class="modal-footer">
                <%= button_to team_path(team), method: :delete, class: "btn btn-danger" do %>
                  Delete Team
                <% end %>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      <% end %>

    </div>
  </div>
</div>